models:
  - name: rsTracksUnionPages
    model_type: sql_template
    model_spec:
      validity_time: 24h # 1 day
      materialization:
        output_type: ephemeral
        run_type: discrete
      single_sql: |
        {% with Tracks = this.DeRef("models/rsTracks") Pages = this.DeRef("models/rsPages") %}
            select user_id, anonymous_id, context_session_id, timestamp from (
            select ANONYMOUS_ID,USER_ID,cast(timestamp as date) as dt,CONTEXT_SESSION_ID,min(timestamp) as timestamp from {{Tracks}} group by user_id, anonymous_id, context_session_id, cast(timestamp as date)
            union all
            select ANONYMOUS_ID,USER_ID,cast(timestamp as date) as dt,CONTEXT_SESSION_ID,max(timestamp) as timestamp from {{Tracks}} group by user_id, anonymous_id, context_session_id, cast(timestamp as date)) a
            union all
            select user_id, anonymous_id, context_session_id, timestamp from
            (select ANONYMOUS_ID,USER_ID,cast(timestamp as date) as dt,CONTEXT_SESSION_ID,min(timestamp) as timestamp from {{Pages}} group by user_id, anonymous_id, context_session_id, cast(timestamp as date)
            union all
            select ANONYMOUS_ID,USER_ID,cast(timestamp as date) as dt,CONTEXT_SESSION_ID,max(timestamp) as timestamp from {{Pages}} group by user_id, anonymous_id, context_session_id, cast(timestamp as date))
        {% endwith %}
      ids:
        - select: "user_id"
          type: user_id
          entity: user
        - select: "anonymous_id"
          type: anonymous_id
          entity: user
      contract:
        is_optional: false
        is_event_stream: false
        with_entity_ids:
          - user
        with_columns:
          - name: user_id
          - name: anonymous_id
  - name: rsPagesFinal
    model_type: sql_template
    model_spec:
      validity_time: 24h # 1 day
      materialization:
        output_type: ephemeral
        run_type: discrete
      single_sql: |
        {% with Pages = this.DeRef("models/rsPages") %}
            select * from {{Pages}}
        {% endwith %}
      ids:
        - select: user_id
          type: user_id
          entity: user
        - select: anonymous_id
          type: anonymous_id
          entity: user
      contract:
        is_optional: false
        is_event_stream: false
        with_entity_ids:
          - user
        with_columns:
          - name: user_id
          - name: anonymous_id
  - name: rsIdentifiesFinal
    model_type: sql_template
    model_spec:
      validity_time: 24h # 1 day
      materialization:
        output_type: ephemeral
        run_type: discrete
      single_sql: |
        {% with Identifies = this.DeRef("models/rsIdentifies") %}
            select * from {{Identifies}}
        {% endwith %}
      ids:
        - select: user_id
          type: user_id
          entity: user
        - select: anonymous_id
          type: anonymous_id
          entity: user
        - select: lower(email)
          type: email
          entity: user
      contract:
        is_optional: false
        is_event_stream: false
        with_entity_ids:
          - user
        with_columns:
          - name: user_id
          - name: anonymous_id
